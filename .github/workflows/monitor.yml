name: Vessel Monitor (Git Persistence)

on:
  schedule:
    # Corrected Cron: Added the 5th field (Minute Hour Day Month DayOfWeek)
    - cron: '*/30 * * * *'       # Run every 30 mins (Mode Monitor)
    - cron: '0 8 1 * *'          # Run 1st of month at 08:00 (Mode Report)
  workflow_dispatch:             # Allows manual testing from the Actions tab

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0         # Fetch full history for better Git management

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üîç Check Environment & State
        run: |
          echo "--- Runner Info ---"
          echo "Date: $(date)"
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "--- File Check ---"
          if [ -f "state.json" ]; then 
            echo "‚úÖ state.json exists. Size: $(du -h state.json | cut -f1)"
          else 
            echo "‚ö†Ô∏è state.json not found. A new one will be created."
          fi

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: üöÄ Run Monitor / Report Script
        env:
          # Secrets
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_TO_COLLEAGUE: ${{ secrets.EMAIL_TO_COLLEAGUE }}
          EMAIL_ENABLED: "true"
          
          # Logic: If triggered by the monthly schedule, set mode to 'report'
          RUN_MODE: ${{ github.event.schedule == '0 8 1 * *' && 'report' || 'monitor' }}
        run: python monitor.py

      - name: üíæ Commit and Push State
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action Bot"
          git add state.json
          
          # Check for changes in the staging area
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to state.json. Nothing to commit."
          else
            echo "üìä Changes detected in state.json:"
            git diff --staged --shortstat
            git commit -m "Update state.json [skip ci]"
            git push
            echo "‚úÖ State successfully updated in repository."
          fi

      - name: üëÅÔ∏è Final Debug View
        if: always() # Runs even if the script or git steps fail
        run: |
          echo "--- End of Job Summary ---"
          if [ -f "state.json" ]; then
            echo "Last 5 lines of state.json:"
            tail -n 5 state.json
          else
            echo "‚ùå state.json was not generated."
          fi
