name: Vessel Monitor

on:
  schedule:
    - cron: '*/30 * * * *'       # Monitor mode
    - cron: '0 8 1 * *'          # Report mode (1st of month)
  workflow_dispatch:             # Manual trigger

# Prevent overlapping runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Increased from default (6h is max but 10min is safer)
    permissions:
      contents: write
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üì¶ Install Dependencies
        run: |
          pip install requests

      - name: üöÄ Run Script with Correct Mode
        id: run-script
        env:
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_TO_COLLEAGUE: ${{ secrets.EMAIL_TO_COLLEAGUE }}
          EMAIL_ENABLED: "true"
        run: |
          # Determine mode
          RUN_MODE="monitor"
          
          if [[ "${{ github.event.schedule }}" == "0 8 1 * *" ]]; then
            RUN_MODE="report"
          fi
          
          echo "Using mode: $RUN_MODE"
          echo "RUN_MODE=$RUN_MODE" >> $GITHUB_ENV
          
          python monitor.py

      - name: üíæ Commit and Push State and History
        if: success() || failure()  # Always try to save state even if script failed
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add state.json history.json
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to data files"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            if [[ "$RUN_MODE" == "report" ]]; then
              git commit -m "üìä Monthly report & History Archive - $TIMESTAMP [skip ci]"
            else
              git commit -m "ü§ñ Vessel state update - $TIMESTAMP [skip ci]"
            fi
            
            # Push with retry
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Data committed successfully"
                break
              else
                echo "‚ö†Ô∏è Push attempt $i failed, pulling and retrying..."
                git pull --rebase || true
                sleep 2
              fi
            done
          fi
