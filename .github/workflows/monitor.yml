name: Vessel Monitor (Persistent State)

on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      # 1. Checkout
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2. Python Setup
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      # 3. Initialize Output File with Current State (THE FIX)
      - name: ðŸ“ Initialize Output File with Current State
        run: |
          echo '${{ secrets.VESSEL_STATE_DATA }}' > state_output.txt
          echo "DEBUG: Initial state successfully written to state_output.txt."

      # 4. Run Python Script
      - name: Execute Monitor Script
        id: run_script
        env:
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }}
          EMAIL_USER:           ${{ secrets.EMAIL_USER }}
          EMAIL_PASS:           ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:             ${{ secrets.EMAIL_TO }}
          EMAIL_TO_COLLEAGUE:   ${{ secrets.EMAIL_TO_COLLEAGUE }}
          EMAIL_ENABLED: "true"
          CALLMEBOT_PHONE:      ${{ secrets.CALLMEBOT_PHONE }}
          CALLMEBOT_APIKEY:     ${{ secrets.CALLMEBOT_APIKEY }}
          CALLMEBOT_ENABLED:    "false"
        run: python monitor.py

      # 5. Show the state file (optional)
      - name: ðŸ‘€ Show state_output.txt
        if: success() 
        run: |
          echo "=== state_output.txt ==="
          cat state_output.txt

      # 6. Update Secret
      - name: ðŸ’¾ Update GitHub Secret with New State
        if: success() 
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # This will now work because state_output.txt is guaranteed to exist
          NEW_STATE_VALUE="$(cat state_output.txt)"
          echo "Updating secret with new state..."
          gh secret set VESSEL_STATE_DATA --body "$NEW_STATE_VALUE"
