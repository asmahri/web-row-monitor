name: Vessel Monitor (Persistent State)

on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # CRITICAL: Grant write permissions to update secrets
    permissions:
      contents: write
    
    steps:
      # 1. Checkout
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # 2. Python Setup
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      # 3. Run Python Script
      - name: Execute Monitor Script
        id: run_script
        env:
          # State persistence
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }}

          # Email credentials
          EMAIL_USER:           ${{ secrets.EMAIL_USER }}
          EMAIL_PASS:           ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:             ${{ secrets.EMAIL_TO }}
          # ADDED: Colleague Email (for La√¢youne)
          EMAIL_TO_COLLEAGUE:   ${{ secrets.EMAIL_TO_COLLEAGUE }}

          # Enable emails
          EMAIL_ENABLED: "true"

          # WhatsApp (CallMeBot)
          CALLMEBOT_PHONE:      ${{ secrets.CALLMEBOT_PHONE }}
          CALLMEBOT_APIKEY:     ${{ secrets.CALLMEBOT_APIKEY }}
          CALLMEBOT_ENABLED:    "false"

        run: python monitor.py

      # 4. Show the state file (only if it exists)
      - name: üëÄ Show state_output.txt
        if: hashFiles('state_output.txt') != ''
        run: |
          echo "=== state_output.txt ==="
          cat state_output.txt

      # 5. Update Secret directly from file
      - name: üíæ Update GitHub Secret with New State
        if: success() 
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ -f "state_output.txt" ]; then
            NEW_STATE_VALUE="$(cat state_output.txt)"
            echo "Updating secret with new state..."
            gh secret set VESSEL_STATE_DATA --body "$NEW_STATE_VALUE"
          else
            echo "Error: state_output.txt was not created by the script."
            exit 1
          fi
