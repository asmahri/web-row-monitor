name: Vessel Monitor (Persistent State)

# Define when the workflow should run
on:
  schedule:
    - cron: '*/30 * * * *' 
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # --- Setup ---
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      # --- State Management Core ---
      
      # 1. READ OLD STATE AND INITIALIZE OUTPUT FILE (THE FIX!)
      # This step ensures the state_output.txt file always exists, preventing the "No such file" error.
      - name: ðŸ“ Initialize Output File with Current State
        run: |
          # Writes the content of the persistent secret into the temporary file.
          echo '${{ secrets.VESSEL_STATE_DATA }}' > state_output.txt
          echo "DEBUG: Initial state successfully written to state_output.txt."

      # 2. EXECUTE MONITOR SCRIPT
      # The Python script reads the state from the environment and overwrites 
      # state_output.txt ONLY if new changes are found.
      - name: Execute Monitor Script
        id: run_script
        env:
          # READ: Pass the existing state from the GitHub Secret 
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }} 
          
          # Pass Email Credentials
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: python monitor.py
        
      # 3. READ NEW STATE FROM OUTPUT FILE
      # This step now successfully reads the file content, which is either the old 
      # state (from initialization) or the new state (from the Python script).
      - name: ðŸ“„ Read New State from Output File
        id: read_state
        run: echo "NEW_STATE_VALUE=$(cat state_output.txt)" >> $GITHUB_OUTPUT 
      
      # 4. SAVE NEW STATE BACK TO SECRET
      # Updates the persistent secret with the final value.
      - name: ðŸ’¾ Update GitHub Secret with New State
        run: |
          # Use the variable written to GITHUB_OUTPUT in the previous step
          NEW_STATE_VALUE='${{ steps.read_state.outputs.NEW_STATE_VALUE }}'
          
          echo "Updating secret with new state for ${#NEW_STATE_VALUE} characters..."
          
          # This command requires the 'repo' scope on the GH_TOKEN secret.
          gh secret set VESSEL_STATE_DATA --body "$NEW_STATE_VALUE"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }} 
          GH_REPO: ${{ github.repository }}
