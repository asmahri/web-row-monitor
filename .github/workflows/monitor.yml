name: Vessel Monitor

on:
  schedule:
    - cron: '*/30 * * * *'       # Monitor mode
    - cron: '0 8 1 * *'          # Report mode (1st of month)
  workflow_dispatch:             # Manual trigger

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # token: ${{ secrets.GITHUB_TOKEN }}  # Optional: GitHub provides this by default

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ” Check Environment
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install requests

      - name: ðŸš€ Run Script with Correct Mode
        env:
          VESSEL_STATE_DATA: ${{ secrets.VESSEL_STATE_DATA }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_TO_COLLEAGUE: ${{ secrets.EMAIL_TO_COLLEAGUE }}
          EMAIL_ENABLED: "true"
        run: |
          # Determine mode
          RUN_MODE="monitor"
          
          if [[ "${{ github.event.schedule }}" == "0 8 1 * *" ]]; then
            RUN_MODE="report"
          fi
          
          echo "Using mode: $RUN_MODE"
          
          # CRITICAL FIX: Persist RUN_MODE for the next step
          echo "RUN_MODE=$RUN_MODE" >> $GITHUB_ENV
          
          python monitor.py

      - name: ðŸ’¾ Commit and Push State and History
        # No env needed here; git push uses the auth set by checkout
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Track both state.json and history.json
          git add state.json history.json
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to data files"
          else
            # $RUN_MODE is now available here because we used GITHUB_ENV
            if [[ "$RUN_MODE" == "report" ]]; then
              git commit -m "ðŸ“Š Monthly report & History Archive [skip ci]"
            else
              git commit -m "ðŸ¤– Vessel state update [skip ci]"
            fi
            git push
            echo "âœ… Data committed"
          fi
